{
  "hash": "77a629411802bb6fd5f0e7a9c7ecee79",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"\"\nmessage: false\nwarning: false\n---\n\n# Anthesis Date Estimation from Climate Data\n\n## Libraries\n\nLoad required libraries\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\nlibrary(purrr)\nlibrary(gsheet)\nlibrary(raster)\nlibrary(ncdf4)\nlibrary(lubridate)\nlibrary(readxl)\nlibrary(writexl)\nlibrary(caret)\nlibrary(tidyr)\nlibrary(r4pde)\nlibrary(refund)\nlibrary(ggplot2)\nlibrary(readr)\nlibrary(nasapower)\n```\n:::\n\n\n## Importing and Processing the Experimental Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#  Import trial dataset containing municipalities, planting dates, and coordinates\ngib <- gsheet2tbl(\"https://docs.google.com/spreadsheets/d/1MBiKsosQ8Hob6LkS65_1pPU25hx1CO9i42Sm_xf28ww/edit?gid=2128367221 gid=2128367221\")\n\ntrials <- gib |> \n  mutate(\n    planting_date = as.Date(planting_date, format = \"%Y-%m-%d\"),\n    pd120 = as.Date(planting_date + 120),   #   120-day growing period\n    study = as.factor(study),\n    year = as.factor(year)) |> \n  dplyr::select(study, planting_date, lon, lat, pd120) |>\n  rename(longitude = lon,\n         latitude = lat)\n```\n:::\n\n\n## Weather Data Acquisition\n\n### From NASA POWER\n\n\n::: {.cell}\n\n```{.r .cell-code}\nweather_nasa <- trials %>%\n  rowwise() %>%\n  mutate(\n    weather = list(\n      get_power(\n        community = \"AG\", \n        lonlat = c(longitude, latitude),\n        pars = c(\"T2M\", \"T2M_MAX\", \"T2M_MIN\", \"RH2M\", \"PRECTOTCORR\"),\n        dates = c(as.character(planting_date), as.character(pd120)),\n        temporal_api = \"DAILY\"\n      )\n    )\n  ) %>%\n  unnest(weather) |> \n  rename(Tmax = T2M_MAX,\n         Tmin = T2M_MIN,\n         date = YYYYMMDD)\n```\n:::\n\n\n### From Xavier Dataset (NetCDF)\n\nThis repository is intended to demonstrate the structure and workflow of the code used in the project. To keep the repository lightweight and accessible on GitHub, the original input data files (provided by Xavier et al. 2022) have been excluded because they exceed GitHub's file size limits.\n\nThe corresponding lines in the code that load these large .nc files are commented out (using ). This way, the code can still be inspected and followed without requiring the full dataset. However, the scripts will not reproduce the complete analysis unless the data are available locally.\n\nThe full dataset can be obtained from Xavier et al. (2022) at the following link: [Xavier Dataset â€“ Download here](https://sites.google.com/site/alexandrecandidoxavierufes/brazilian-daily-weather-gridded-data)\n\nAfter downloading, place the files in the `data/` directory of this repository and uncomment the relevant lines in the scripts to run the full analysis.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#  Keep only studies with available NetCDF coverage\ntrials <- trials |> \n  filter(study %in% 1:91)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#   #     Generic function to extract daily climate variables from NetCDF\n# extract_nc_var <- function(netcdf_path, trials, varname, outfile) {\n#   nc_data <- nc_open(netcdf_path)\n  \n#   #     Convert time variable to Date\n#   time_var   <- ncvar_get(nc_data, \"time\")\n#   time_units <- ncatt_get(nc_data, \"time\", \"units\")$value\n#   origin_date <- as.POSIXct(sub(\"hours since \", \"\", time_units), tz = \"UTC\")\n#   nc_dates   <- as.Date(origin_date + as.difftime(time_var, units = \"hours\"))\n  \n#     Grid coordinates\n#   lon_vals <- ncvar_get(nc_data, \"longitude\")\n#   lat_vals <- ncvar_get(nc_data, \"latitude\")\n  \n#     Internal extractor for each trial\n#   get_data_for_row <- function(row) {\n#     date_seq <- seq.Date(row$planting_date, row$pd120, by = \"day\")\n#     date_idx <- match(date_seq, nc_dates)\n#     date_idx <- date_idx[!is.na(date_idx)]\n#     if (length(date_idx) == 0) return(NULL)\n    \n#     lon_idx <- which.min(abs(lon_vals - row$longitude))\n#     lat_idx <- which.min(abs(lat_vals - row$latitude))\n    \n#     values <- sapply(date_idx, function(i) {\n#       ncvar_get(nc_data, varname, start = c(lon_idx, lat_idx, i), count = c(1, 1, 1))\n#     })\n#     if (length(values) == 0 || all(is.na(values))) return(NULL)\n    \n#     df <- data.frame(\n#       date          = date_seq[!is.na(match(date_seq, nc_dates))],\n#       value         = values,\n#       study         = row$study,\n#       year          = format(row$planting_date, \"%Y\"),\n#       planting_date = row$planting_date\n#     )\n#     names(df)[2] <- varname\n#     return(df)\n#   }\n  \n#   result <- trials %>%\n#     split(1:nrow(.)) %>%\n#     map_dfr(get_data_for_row)\n  \n#   write_xlsx(result, outfile)\n#   nc_close(nc_data)\n#   return(result)\n# }\n\n#      # Extract Tmax and Tmin\n# tmax <- extract_nc_var(\"data/Tmax_20010101_20240320_BR-DWGD_UFES_UTEXAS_v_3.2.3.nc\", trials, \"Tmax\", \"data/br_dwgd_tmax.xlsx\")\n# tmin <- extract_nc_var(\"data/Tmin_20010101_20240320_BR-DWGD_UFES_UTEXAS_v_3.2.3.nc\", trials, \"Tmin\", \"data/br_dwgd_tmin.xlsx\")\n\n#   # Merge and compute mean daily temperature\n#weather_xavier <- tmax |> \n#  mutate(Tmin = tmin$Tmin, T2M = (Tmax + Tmin)/2)\n\n#write_xlsx(weather_xavier, \"plan/weather_xavier_flowering.xlsx\")\nweather_xavier <- read_xlsx(\"plan/weather_xavier_flowering.xlsx\")\n```\n:::\n\n\n## Estimation of Anthesis (Flowering Date)\n\n### General Functions\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#  Temperature limits for wheat growth\nTmin <- 0     #Lower limit\nTmax <- 40    #Upper limit\n\n#  Daily growing degree-days (GDD) calculation\ncalculate_gdd_phase <- function(T2M, Tmin, Tmax, Tbase) {\n  if (T2M < Tmin || T2M > Tmax) return(0)\n  GDD <- T2M - Tbase\n  return(ifelse(GDD > 0, GDD, 0))\n}\n\n#  Basal temperatures and cumulative thresholds (by growth stage)\nTbase <- c(2.1, 4.76, 0.86, 8.44)     #Sm-Em, Em-DA, DA-ET, ET-AN\nthresholds <- c(80, 100, 300, 750)    #Accumulated GDD thresholds\n\n#  Function to assign phenological phases by study\ncalculate_phases_by_study <- function(df) {\n  total_gdd <- 0\n  phase_num <- 1\n  gd_values <- numeric(nrow(df))\n  gdcumul_values <- numeric(nrow(df))\n  phases <- character(nrow(df))\n  \n  for (day in 1:nrow(df)) {\n    T2M <- df$T2M[day]\n    GDD <- calculate_gdd_phase(T2M, Tmin, Tmax, Tbase[phase_num])\n    total_gdd <- total_gdd + GDD\n    gd_values[day] <- GDD\n    gdcumul_values[day] <- total_gdd\n    \n    if (is.na(total_gdd)) {\n      phases[day] <- NA\n    } else if (total_gdd < thresholds[1]) {\n      phases[day] <- \"Planting\"\n    } else if (total_gdd < thresholds[2]) {\n      phases[day] <- \"Emergence\"\n    } else if (total_gdd < thresholds[3]) {\n      phases[day] <- \"Double Ridge\"\n    } else if (total_gdd < thresholds[4]) {\n      phases[day] <- \"Terminal Spikelet\"\n    } else {\n      phases[day] <- \"Anthesis\"\n    }\n    \n    if (phase_num <= length(thresholds) && total_gdd >= thresholds[phase_num]) {\n      phase_num <- phase_num + 1\n    }\n  }\n  \n  df <- df %>%\n    mutate(gd = gd_values, gdcumul = gdcumul_values, phase = phases)\n  return(df)\n}\n\n#  Function to compute anthesis date per dataset\ncompute_anthesis <- function(weather_data) {\n  weather_data %>%\n    group_by(study) %>%\n    group_modify(~ calculate_phases_by_study(.x)) %>%\n    ungroup() %>%\n    group_by(study) %>%\n    mutate(flowering = as.Date(date[phase == \"Anthesis\"][1]),\n           dias_para_antese = as.numeric(flowering - planting_date)) %>%\n    distinct(study, dias_para_antese, .keep_all = TRUE) %>%\n    dplyr::select(study, dias_para_antese)\n}\n```\n:::\n\n\n### Apply to NASA and Xavier Datasets\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnasa   <- compute_anthesis(weather_nasa)\nxavier <- compute_anthesis(weather_xavier)\n```\n:::\n\n\n## Final Note on Flowering Date\n\nFor subsequent analyses, the flowering date was defined as the mean number of days to anthesis across the NASA POWER and Xavier datasets, when both were available. For studies where only NASA POWER data existed, flowering was estimated exclusively from that source. The anthesis date was calculated as:\n\nPlanting date + estimated days to anthesis.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}