"0","# Probabilistic Sensitivity Analysis (PSA)"
"0","# Compute population-level and per-treated-unit NMB for each threshold"
"0",""
"0","compute_psa <- function(y, p_hat, ths, slope_kg, P, rE, rC, S = 10000){"
"0","  N <- length(y)"
"0","  map_dfr(ths, function(pt){"
"0","    pred <- p_hat >= pt"
"0","    TP   <- sum(pred & y == 1)"
"0","    Tt   <- sum(pred)"
"0","    PPV  <- if (Tt > 0) TP / Tt else 0"
"0",""
"0","    # Sampling of efficacy, cost, and severity points"
"0","    E      <- rE(S)"
"0","    C      <- rC(S)"
"0","    P      <- rP(S)       # wheat price in USD/kg"
"0","    P_saca <- P * 60"
"0","    s_pts  <- draw_s_pts(pt, S)"
"0",""
"0","    # Benefit per epidemic (USD/ha)"
"0","    B <- (d_pct / 100) * E * s_pts * Y0_kg_ha * P"
"0",""
"0","    # NMB per population unit and per treated unit"
"0","    NMB_pop  <- (TP / N) * B - (Tt / N) * C"
"0","    NMB_trat <- PPV * B - C"
"0",""
"0","    req_PPV <- pmin(C / pmax(B, 1e-9), 1)"
"0",""
"0","    tibble("
"0","      pt,"
"0","      NMB_mean      = mean(NMB_pop),"
"0","      NMB_lo        = unname(quantile(NMB_pop, 0.025)),"
"0","      NMB_hi        = unname(quantile(NMB_pop, 0.975)),"
"0","      Pr_pos        = mean(NMB_pop > 0),"
"0","      Pr_ge_1saca   = mean(NMB_pop >= P_saca),"
"0","      NMB_trat_mean = mean(NMB_trat),"
"0","      NMB_trat_lo = unname(quantile(NMB_trat, 0.025)),"
"0","      NMB_trat_hi = unname(quantile(NMB_trat, 0.975)),"
"0","      Pr_trat_pos   = mean(NMB_trat > 0),"
"0","      PPV           = PPV,"
"0","      PPV_req_med   = median(req_PPV),"
"0","      PPV_req_lo    = quantile(req_PPV, 0.10),"
"0","      PPV_req_hi    = quantile(req_PPV, 0.90)"
"0","    )"
"0","  })"
"0","}"
"0",""
"0","# Run PSA and save results"
"0","res <- compute_psa(y, p_hat, ths, slope_kg, P_usd_per_kg, rE, rC, S)"
"0","write_csv(res, ""plan/res.csv"")"
