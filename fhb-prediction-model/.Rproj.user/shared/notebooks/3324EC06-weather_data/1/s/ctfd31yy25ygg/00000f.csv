"0","# ============================================================"
"0","# Function to extract daily climate data (precipitation, Tmax, Tmin, relative humidity, etc.) from NetCDF files for the locations and periods defined in 'gib'."
"0","# ============================================================"
"0",""
"0","extract_nc_var <- function(netcdf_path, gib, varname, outfile) {"
"0","  # Open NetCDF file"
"0","  nc_data <- nc_open(netcdf_path)"
"0","  "
"0","  # Extract time variable and convert to Date"
"0","  time_var   <- ncvar_get(nc_data, ""time"")"
"0","  time_units <- ncatt_get(nc_data, ""time"", ""units"")$value"
"0","  origin_date <- as.POSIXct(sub(""hours since "", """", time_units), tz = ""UTC"")"
"0","  nc_dates   <- as.Date(origin_date + as.difftime(time_var, units = ""hours""))"
"0","  "
"0","  # Extract grid coordinates"
"0","  lon_vals <- ncvar_get(nc_data, ""longitude"")"
"0","  lat_vals <- ncvar_get(nc_data, ""latitude"")"
"0","  "
"0","  # Internal function to extract data for each row of 'gib'"
"0","  get_data_for_row <- function(row, line_number) {"
"0","    start_date <- row$pd00"
"0","    end_date   <- row$pd28"
"0","    date_seq   <- seq.Date(start_date, end_date, by = ""day"")"
"0","    date_idx   <- match(date_seq, nc_dates)"
"0","    date_idx   <- date_idx[!is.na(date_idx)]"
"0","    "
"0","    if (length(date_idx) == 0) return(NULL)"
"0","    "
"0","    # Find closest grid point"
"0","    lon_idx <- which.min(abs(lon_vals - row$lon))"
"0","    lat_idx <- which.min(abs(lat_vals - row$lat))"
"0","    "
"0","    # Extract values"
"0","    values <- sapply(date_idx, function(i) {"
"0","      ncvar_get(nc_data, varname,"
"0","                start = c(lon_idx, lat_idx, i),"
"0","                count = c(1, 1, 1))"
"0","    })"
"0","    "
"0","    if (length(values) == 0 || all(is.na(values))) return(NULL)"
"0","    "
"0","    # Build dataframe"
"0","    df <- data.frame("
"0","      date          = date_seq[!is.na(match(date_seq, nc_dates))],"
"0","      value         = values,"
"0","      study         = row$study,"
"0","      location      = row$location,"
"0","      state         = row$state,"
"0","      year          = format(start_date, ""%Y""),"
"0","      planting_date = row$planting_date"
"0","    )"
"0","    "
"0","    names(df)[2] <- varname"
"0","    return(df)"
"0","  }"
"0","  "
"0","  # Apply function for each row of 'gib'"
"0","  result <- gib %>%"
"0","    split(1:nrow(.)) %>%"
"0","    map2_dfr(1:nrow(gib), ~ get_data_for_row(.x, .y), .id = ""id"")"
"0","  "
"0","  # Save as Excel"
"0","  write_xlsx(result, outfile)"
"0","  "
"0","  # Close NetCDF"
"0","  nc_close(nc_data)"
"0","  return(result)"
"0","}"
"0",""
