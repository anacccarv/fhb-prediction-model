"0","pr_auc_bootstrap <- function(model, data, response, B = 1000, seed = 123) {"
"0","  set.seed(seed)"
"0","  "
"0","  # Internal function to compute PR-AUC"
"0","  pr_auc_fun <- function(y, p) {"
"0","    y <- as.integer(y)"
"0","    if (length(unique(y)) < 2) return(NA_real_)"
"0","    PRROC::pr.curve("
"0","      scores.class0 = p[y == 1],"
"0","      scores.class1 = p[y == 0],"
"0","      curve = FALSE"
"0","    )$auc.integral"
"0","  }"
"0","  "
"0","  # Extract response and predicted probabilities"
"0","  y_full <- data[[response]]"
"0","  p_full <- predict(model, type = ""fitted"")"
"0","  "
"0","  # Apparent PR-AUC"
"0","  pr_apparent <- pr_auc_fun(y_full, p_full)"
"0","  "
"0","  # Bootstrap to estimate optimism"
"0","  n <- nrow(data)"
"0","  opt_vec <- numeric(B)"
"0","  for (b in 1:B) {"
"0","    idx_boot <- sample.int(n, replace = TRUE)"
"0","    dat_boot <- data[idx_boot, , drop = FALSE]"
"0","    fit_b <- update(model, data = dat_boot)"
"0","    "
"0","    y_boot <- dat_boot[[response]]"
"0","    p_boot <- predict(fit_b, type = ""fitted"")"
"0","    pr_apparent_b <- pr_auc_fun(y_boot, p_boot)"
"0","    "
"0","    p_test_on_orig <- predict(fit_b, newdata = data, type = ""fitted"")"
"0","    pr_test_b <- pr_auc_fun(y_full, p_test_on_orig)"
"0","    "
"0","    opt_vec[b] <- pr_apparent_b - pr_test_b"
"0","  }"
"0","  "
"0","  opt_mean <- mean(na.omit(opt_vec))"
"0","  pr_corrected <- pr_apparent - opt_mean"
"0","  "
"0","  # Bootstrap percentile confidence interval"
"0","  pr_test_vec <- numeric(B)"
"0","  for (b in 1:B) {"
"0","    idx_boot <- sample.int(n, replace = TRUE)"
"0","    dat_boot <- data[idx_boot, , drop = FALSE]"
"0","    fit_b <- update(model, data = dat_boot)"
"0","    p_test_on_orig <- predict(fit_b, newdata = data, type = ""fitted"")"
"0","    pr_test_vec[b] <- pr_auc_fun(y_full, p_test_on_orig)"
"0","  }"
"0","  "
"0","  ci <- quantile(na.omit(pr_test_vec), c(0.025, 0.975))"
"0","  "
"0","  # Return results as a list"
"0","  list("
"0","    pr_apparent = pr_apparent,"
"0","    pr_corrected = pr_corrected,"
"0","    optimism = opt_mean,"
"0","    ci_95 = ci"
"0","  )"
"0","}"
"0",""
