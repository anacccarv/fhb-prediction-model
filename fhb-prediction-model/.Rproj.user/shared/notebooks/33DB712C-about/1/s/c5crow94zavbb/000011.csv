"0"," #     Generic function to extract daily climate variables from NetCDF"
"0"," extract_nc_var <- function(netcdf_path, trials, varname, outfile) {"
"0","   nc_data <- nc_open(netcdf_path)"
"0","  "
"0","#     Convert time variable to Date"
"0","   time_var   <- ncvar_get(nc_data, ""time"")"
"0","   time_units <- ncatt_get(nc_data, ""time"", ""units"")$value"
"0","   origin_date <- as.POSIXct(sub(""hours since "", """", time_units), tz = ""UTC"")"
"0","   nc_dates   <- as.Date(origin_date + as.difftime(time_var, units = ""hours""))"
"0","  "
"0","#     Grid coordinates"
"0","   lon_vals <- ncvar_get(nc_data, ""longitude"")"
"0","   lat_vals <- ncvar_get(nc_data, ""latitude"")"
"0","  "
"0","#     Internal extractor for each trial"
"0","   get_data_for_row <- function(row) {"
"0","     date_seq <- seq.Date(row$planting_date, row$pd120, by = ""day"")"
"0","     date_idx <- match(date_seq, nc_dates)"
"0","     date_idx <- date_idx[!is.na(date_idx)]"
"0","     if (length(date_idx) == 0) return(NULL)"
"0","    "
"0","     lon_idx <- which.min(abs(lon_vals - row$longitude))"
"0","     lat_idx <- which.min(abs(lat_vals - row$latitude))"
"0","    "
"0","     values <- sapply(date_idx, function(i) {"
"0","       ncvar_get(nc_data, varname, start = c(lon_idx, lat_idx, i), count = c(1, 1, 1))"
"0","     })"
"0","     if (length(values) == 0 || all(is.na(values))) return(NULL)"
"0","    "
"0","     df <- data.frame("
"0","       date          = date_seq[!is.na(match(date_seq, nc_dates))],"
"0","       value         = values,"
"0","       study         = row$study,"
"0","       year          = format(row$planting_date, ""%Y""),"
"0","       planting_date = row$planting_date"
"0","     )"
"0","     names(df)[2] <- varname"
"0","     return(df)"
"0","   }"
"0","  "
"0","   result <- trials %>%"
"0","     split(1:nrow(.)) %>%"
"0","     map_dfr(get_data_for_row)"
"0","  "
"0","   write_xlsx(result, outfile)"
"0","   nc_close(nc_data)"
"0","   return(result)"
"0"," }"
"0",""
"0","#      Extract Tmax and Tmin"
"0"," tmax <- extract_nc_var(""data/Tmax_20010101_20240320_BR-DWGD_UFES_UTEXAS_v_3.2.3.nc"", trials, ""Tmax"", ""data/br_dwgd_tmax.xlsx"")"
"0"," tmin <- extract_nc_var(""data/Tmin_20010101_20240320_BR-DWGD_UFES_UTEXAS_v_3.2.3.nc"", trials, ""Tmin"", ""data/br_dwgd_tmin.xlsx"")"
"0",""
"0","# Merge and compute mean daily temperature"
"0","weather_xavier <- tmax |> "
"0","  mutate(Tmin = tmin$Tmin, T2M = (Tmax + Tmin)/2)"
"0",""
"0","write_xlsx(weather_xavier, ""plan/weather_xavier_flowering.xlsx"")"
"0","weather_xavier <- read_xlsx(""plan/weather_xavier_flowering.xlsx"")"
